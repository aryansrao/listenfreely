<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListenFreely</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600&family=Dancing+Script:wght@700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fafafa;
            min-height: 100vh;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #000;
            border-right: 1px solid #1a1a1a;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-family: 'Dancing Script', cursive;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 40px;
            color: #fafafa;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #888;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            margin-bottom: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            color: #fafafa;
            background: #0a0a0a;
        }

        .nav-item.active {
            color: #fafafa;
            background: #0f0f0f;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: 120px;
        }

        .search-bar {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 24px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            max-width: 500px;
        }

        .search-bar svg {
            width: 18px;
            height: 18px;
            color: #666;
        }

        .search-input {
            background: none;
            border: none;
            color: #fafafa;
            font-family: 'Geist', sans-serif;
            font-size: 14px;
            flex: 1;
            outline: none;
        }

        .search-input::placeholder {
            color: #666;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .tracks-grid {
            display: grid;
            gap: 8px;
        }

        .track-card {
            background: #0a0a0a;
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .track-card:hover {
            background: #0f0f0f;
            border-color: #1a1a1a;
        }

        .track-cover {
            width: 56px;
            height: 56px;
            border-radius: 4px;
            background: #1a1a1a;
            object-fit: cover;
            flex-shrink: 0;
        }

        .track-details {
            flex: 1;
            min-width: 0;
        }

        .track-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-subtitle {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Ensure all track lists (search, recent, liked) fit the container and don't cause horizontal overflow
           This mirrors the recent-items layout and forces truncation for long titles */
        .tracks-grid {
            width: 100%;
            box-sizing: border-box;
            padding: 0;
            display: grid;
            gap: 8px;
        }

        .tracks-grid .track-card {
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tracks-grid .track-details {
            flex: 1 1 auto;
            min-width: 0;
            overflow: hidden;
        }

        /* Keep action buttons from growing and forcing overflow */
        .tracks-grid .track-actions {
            flex: 0 0 auto;
            display: flex;
            gap: 8px;
        }

        .tracks-grid .track-cover {
            flex-shrink: 0;
        }

        .track-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            color: #fafafa;
            background: #1a1a1a;
        }

        .icon-btn.active {
            color: #fafafa;
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
        }

        .player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0a0a0a;
            border-top: 1px solid #1a1a1a;
            padding: 16px 24px;
        }

        .player-content {
            display: flex;
            align-items: center;
            gap: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .player-track {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 280px;
        }

        .player-cover {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            background: #1a1a1a;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-cover.placeholder {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        }

        .player-cover.placeholder svg {
            width: 24px;
            height: 24px;
            color: #666;
        }

        .player-info {
            flex: 1;
            min-width: 0;
        }

        .player-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-artist {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .source-badge {
            display: inline-block;
            background: #1a1a1a;
            color: #888;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 6px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .api-section {
            margin-bottom: 32px;
        }

        .api-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #1a1a1a;
        }

        .api-name {
            font-size: 14px;
            font-weight: 600;
            color: #fafafa;
        }

        .api-count {
            font-size: 12px;
            color: #666;
        }

        .player-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .controls-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-button {
            background: none;
            border: none;
            color: #fafafa;
            cursor: pointer;
            padding: 6px;
            transition: all 0.2s;
        }

        .control-button:hover {
            transform: scale(1.1);
        }

        .control-button svg {
            width: 20px;
            height: 20px;
        }

        .control-button.play-btn svg {
            width: 16px;
            height: 16px;
        }

        .control-button.play-btn {
            background: #fafafa;
            color: #000;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-button.play-btn:hover {
            background: #fff;
            transform: scale(1.05);
        }

        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            max-width: 500px;
        }

        .time-label {
            font-size: 11px;
            color: #666;
            min-width: 36px;
            text-align: center;
        }

        .progress-track {
            flex: 1;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: #fafafa;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }

        .player-extra {
            width: 280px;
            display: flex;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #888;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            background: #000;
            border: 1px solid #1a1a1a;
            color: #fafafa;
            padding: 10px 12px;
            border-radius: 6px;
            font-family: 'Geist', sans-serif;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-family: 'Geist', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #fafafa;
            color: #000;
        }

        .btn-primary:hover {
            background: #fff;
        }

        .btn-secondary {
            background: #1a1a1a;
            color: #fafafa;
        }

        .btn-secondary:hover {
            background: #2a2a2a;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-danger {
            background: #3a1a1a;
            color: #ff6b6b;
            border: 1px solid #5a2a2a;
        }

        .btn-danger:hover {
            background: #4a2a2a;
            border-color: #7a3a3a;
        }

        .blend-container {
            max-width: 900px;
        }

        .blend-top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .blend-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .blend-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .blend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .blend-avatar svg {
            width: 24px;
            height: 24px;
            color: #666;
        }

        .blend-details {
            flex: 1;
        }

        .blend-name-edit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .blend-name {
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .blend-name:hover {
            color: #888;
        }

        .blend-participants-count {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }

        .participants-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .blend-actions-bar {
            display: flex;
            gap: 8px;
        }

        .now-playing-section {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .now-playing-track {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .now-playing-cover {
            width: 64px;
            height: 64px;
            border-radius: 6px;
            object-fit: cover;
            background: #1a1a1a;
        }

        .now-playing-info {
            flex: 1;
        }

        .now-playing-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .now-playing-artist {
            font-size: 13px;
            color: #888;
        }

        .queue-section-blend {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .queue-item-blend {
            background: #000;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: move;
            transition: all 0.2s;
        }

        .queue-item-blend:hover {
            background: #0a0a0a;
            border-color: #2a2a2a;
        }

        .drag-handle {
            color: #666;
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle svg {
            width: 16px;
            height: 16px;
        }

        .queue-item-cover {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            object-fit: cover;
            background: #1a1a1a;
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-artist {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .blend-search-section {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
        }

        .blend-search-bar {
            background: #000;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .blend-search-bar svg {
            width: 18px;
            height: 18px;
            color: #666;
        }

        .blend-search-input {
            flex: 1;
            background: none;
            border: none;
            color: #fafafa;
            font-family: 'Geist', sans-serif;
            font-size: 14px;
            outline: none;
        }

        .blend-search-input::placeholder {
            color: #666;
        }

        .blend-search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-queue {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-queue svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        /* Tablet Landscape & Desktop */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
                padding: 20px;
            }

            .logo {
                font-size: 28px;
                margin-bottom: 32px;
            }

            .main {
                padding: 20px;
            }

            .blend-container {
                max-width: 100%;
            }
        }

        /* Tablet Portrait */
        @media (max-width: 768px) {
            .app {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-top: 1px solid #1a1a1a;
                padding: 12px 0;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 101;
                background: #0a0a0a;
                order: 3;
            }

            .logo {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                background: #0a0a0a;
                border-bottom: 1px solid #1a1a1a;
                padding: 10px 16px;
                margin-bottom: 0;
                z-index: 102;
                text-align: center;
                font-size: 26px;
            }

            nav {
                display: flex;
                justify-content: space-around;
                align-items: center;
                padding: 0 12px;
            }

            .nav-item {
                flex: 1;
                flex-direction: column;
                gap: 6px;
                margin-bottom: 0;
                padding: 10px 6px;
                text-align: center;
                justify-content: center;
                border-radius: 0;
                background: none;
            }

            .nav-item:hover {
                background: none;
            }

            .nav-item span {
                font-size: 11px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
            }

            .nav-item svg {
                width: 26px;
                height: 26px;
                flex-shrink: 0;
            }

            .nav-item.active {
                background: none;
                color: #fafafa;
            }

            .nav-item.active svg {
                color: #fafafa;
            }

            .main {
                padding: 0;
                padding-top: 75px;
                padding-bottom: 280px;
                order: 1;
            }

            .search-bar {
                max-width: 100%;
                margin: 16px;
                margin-bottom: 12px;
            }

            #searchResults,
            .tracks-grid {
                padding: 0 16px;
            }

            .section-title {
                font-size: 18px;
                padding: 0 16px;
            }

            .player-bar {
                padding: 12px 16px 16px;
                order: 2;
                height: auto;
                position: fixed;
                bottom: 75px;
                left: 0;
                right: 0;
                z-index: 102;
            }

            .player-content {
                flex-direction: column;
                gap: 12px;
                height: auto;
                padding: 0;
            }

            .player-track {
                width: 100%;
                order: 1;
                padding: 0;
            }

            .player-controls {
                order: 2;
                width: 100%;
                gap: 8px;
            }

            .controls-buttons {
                display: flex;
                justify-content: center;
                gap: 16px;
            }

            .control-button svg {
                width: 22px;
                height: 22px;
            }

            .control-button.play-btn {
                width: 42px;
                height: 42px;
            }

            .control-button.play-btn svg {
                width: 18px;
                height: 18px;
            }

            .progress-wrapper {
                max-width: 100%;
                gap: 8px;
            }

            .player-extra {
                display: none;
            }

            .blend-top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .blend-info {
                width: 100%;
            }

            .blend-actions-bar {
                width: 100%;
                justify-content: space-between;
            }


            .modal-content {
                max-width: 90%;
            }

            /* Blend mode: make boxes consistent and prevent cropping on narrow screens */
            .blend-container {
                width: 100%;
                box-sizing: border-box;
                padding: 0 12px;
            }

            .blend-top-bar,
            .now-playing-section,
            .queue-section-blend,
            .blend-search-section {
                width: calc(100% - 24px);
                box-sizing: border-box;
                padding: 14px 16px;
                margin: 0 12px 16px 12px;
                border-radius: 8px;
                overflow: hidden;
                background-clip: padding-box;
                background: #0a0a0a;
                border: 1px solid #1a1a1a;
            }

            .blend-top-bar .blend-info {
                width: 100%;
                min-width: 0;
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .blend-top-bar .blend-details {
                flex: 1 1 auto;
                min-width: 0;
            }

            .blend-top-bar .blend-actions-bar {
                flex: 0 0 auto;
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .queue-section-blend .section-label,
            .blend-search-section .section-label {
                padding-left: 2px;
            }

            .mobile-header {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #0a0a0a;
                border-bottom: 1px solid #1a1a1a;
                padding: 16px;
                z-index: 102;
                font-family: 'Dancing Script', cursive;
                font-size: 26px;
                font-weight: 700;
                color: #fafafa;
                text-align: center;
            }
        }

        /* Mobile Landscape */
        @media (max-width: 640px) and (orientation: landscape) {
            .player-bar {
                padding: 8px 12px;
            }

            .player-content {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .player-track {
                width: 200px;
                order: 1;
            }

            .player-controls {
                flex: 1;
                order: 2;
                min-width: 300px;
            }

            .player-extra {
                width: auto;
                order: 3;
            }

            .main {
                padding-bottom: 100px;
            }
        }

        /* Mobile Portrait */
        @media (max-width: 480px) {
            body {
                overflow-x: hidden;
            }

            .mobile-logo {
                font-size: 24px;
                padding: 14px 16px;
            }

            .sidebar {
                padding: 10px 0;
                bottom: 0;
            }

            nav {
                padding: 0 8px;
            }

            .nav-item {
                padding: 8px 4px;
                gap: 5px;
                min-width: 0;
            }

            .nav-item span {
                font-size: 10px;
            }

            .nav-item svg {
                width: 24px;
                height: 24px;
            }

            .main {
                padding-top: 60px;
                padding-bottom: 240px;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .search-bar {
                padding: 10px 16px;
                margin: 12px 12px 12px;
            }

            #searchResults,
            .tracks-grid {
                padding: 0 12px;
            }

            .search-input {
                font-size: 14px;
            }

            .section-title {
                font-size: 16px;
                margin-bottom: 12px;
                padding: 0 12px;
            }

            .track-card {
                padding: 8px;
                gap: 10px;
            }

            .track-cover {
                width: 48px;
                height: 48px;
            }

            .track-title {
                font-size: 13px;
            }

            .track-subtitle {
                font-size: 12px;
            }

            .icon-btn {
                padding: 6px;
            }

            .icon-btn svg {
                width: 16px;
                height: 16px;
            }

            .player-bar {
                padding: 10px 12px 12px;
                bottom: 65px;
            }

            .player-content {
                gap: 10px;
            }

            .player-track {
                padding: 0;
                gap: 8px;
            }

            .player-cover {
                width: 36px;
                height: 36px;
            }

            .player-title {
                font-size: 12px;
            }

            .player-artist {
                font-size: 10px;
            }

            .source-badge {
                font-size: 8px;
                padding: 1px 4px;
                margin-left: 4px;
            }

            .player-controls {
                padding: 0;
                gap: 6px;
            }

            .controls-buttons {
                gap: 12px;
            }

            .control-button svg {
                width: 20px;
                height: 20px;
            }

            .control-button.play-btn {
                width: 38px;
                height: 38px;
            }

            .control-button.play-btn svg {
                width: 16px;
                height: 16px;
            }

            .progress-wrapper {
                gap: 6px;
            }

            .time-label {
                font-size: 9px;
                min-width: 28px;
            }

            .progress-track {
                height: 4px;
            }

            .blend-top-bar {
                padding: 12px;
            }

            .blend-avatar {
                width: 40px;
                height: 40px;
            }

            .blend-avatar svg {
                width: 20px;
                height: 20px;
            }

            .blend-name {
                font-size: 14px;
            }

            .blend-participants-count {
                font-size: 11px;
            }

            .participants-dot {
                width: 4px;
                height: 4px;
            }

            .btn-small {
                padding: 5px 10px;
                font-size: 11px;
            }

            .now-playing-section,
            .queue-section-blend,
            .blend-search-section {
                padding: 12px;
                margin: 0 12px 12px;
            }

            .section-label {
                font-size: 10px;
                margin-bottom: 8px;
            }

            .now-playing-cover {
                width: 52px;
                height: 52px;
            }

            .now-playing-title {
                font-size: 13px;
            }

            .now-playing-artist {
                font-size: 11px;
            }

            .queue-item-blend {
                padding: 8px;
                gap: 8px;
                margin-bottom: 6px;
            }

            .queue-item-cover {
                width: 40px;
                height: 40px;
            }

            .queue-item-title {
                font-size: 12px;
            }

            .queue-item-artist {
                font-size: 11px;
            }

            .drag-handle svg {
                width: 14px;
                height: 14px;
            }

            .blend-search-bar {
                padding: 10px 12px;
                margin-bottom: 12px;
            }

            .blend-search-input {
                font-size: 13px;
            }

            .blend-search-results {
                max-height: 250px;
            }

            .modal-content {
                padding: 18px;
                max-width: 92%;
            }

            /* Small-screen tweaks for Blend mode */
            .blend-container {
                padding: 0 10px;
            }

            .blend-top-bar,
            .now-playing-section,
            .queue-section-blend,
            .blend-search-section {
                margin: 0 8px 12px 8px;
                padding: 10px 12px;
                border-radius: 8px;
                background: #0a0a0a;
                border: 1px solid #1a1a1a;
                box-sizing: border-box;
            }

            .blend-top-bar .blend-avatar {
                width: 44px;
                height: 44px;
            }

            .blend-top-bar .blend-details {
                min-width: 0;
            }

            /* Make Coming Next list items full-width and responsive */
            .queue-section-blend .queue-item-blend {
                width: 100%;
                box-sizing: border-box;
                padding: 10px;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .queue-section-blend .queue-item-cover {
                width: 56px;
                height: 56px;
                flex-shrink: 0;
            }

            .queue-section-blend .queue-item-info {
                min-width: 0;
                flex: 1 1 auto;
                overflow: hidden;
            }

            .queue-section-blend .drag-handle {
                flex-shrink: 0;
                margin-right: 6px;
            }

            .modal-header {
                font-size: 15px;
                margin-bottom: 14px;
            }

            .form-label {
                font-size: 11px;
                margin-bottom: 5px;
            }

            .form-input {
                padding: 8px 10px;
                font-size: 13px;
            }

            .btn {
                padding: 8px;
                font-size: 12px;
            }

            .api-section {
                margin-bottom: 20px;
            }

            .api-header {
                padding-bottom: 6px;
                margin-bottom: 10px;
            }

            .api-name {
                font-size: 12px;
            }

            .api-count {
                font-size: 10px;
            }

            .empty-state,
            .empty-queue {
                padding: 30px 12px;
            }

            .empty-state svg,
            .empty-queue svg {
                width: 40px;
                height: 40px;
                margin-bottom: 10px;
            }

            .empty-state p,
            .empty-queue p {
                font-size: 13px;
            }
        }

        /* Small Mobile */
        @media (max-width: 360px) {
            .mobile-logo {
                font-size: 22px;
                padding: 12px 14px;
            }

            .sidebar {
                bottom: 0;
                padding: 8px 0;
            }

            nav {
                padding: 0 6px;
            }

            .nav-item {
                padding: 7px 3px;
                gap: 4px;
            }

            .nav-item span {
                font-size: 9px;
            }

            .nav-item svg {
                width: 22px;
                height: 22px;
            }

            .main {
                padding-bottom: 230px;
            }

            .search-bar {
                padding: 8px 14px;
                margin: 10px 10px;
            }

            #searchResults,
            .tracks-grid {
                padding: 0 10px;
            }

            .section-title {
                padding: 0 10px;
            }

            .track-card {
                padding: 6px;
                gap: 8px;
            }

            .track-cover,
            .queue-item-cover {
                width: 40px;
                height: 40px;
            }

            .track-title {
                font-size: 12px;
            }

            .track-subtitle {
                font-size: 11px;
            }

            .track-actions {
                gap: 4px;
            }

            .icon-btn {
                padding: 4px;
            }

            .icon-btn svg {
                width: 14px;
                height: 14px;
            }

            .player-bar {
                padding: 8px 10px 10px;
                bottom: 60px;
            }

            .player-content {
                gap: 8px;
            }

            .player-track {
                gap: 6px;
            }

            .player-cover {
                width: 32px;
                height: 32px;
            }

            .player-title {
                font-size: 11px;
            }

            .player-artist {
                font-size: 9px;
            }

            .source-badge {
                display: none;
            }

            .controls-buttons {
                gap: 10px;
            }

            .control-button svg {
                width: 18px;
                height: 18px;
            }

            .control-button.play-btn {
                width: 34px;
                height: 34px;
            }

            .control-button.play-btn svg {
                width: 14px;
                height: 14px;
            }

            .time-label {
                font-size: 8px;
                min-width: 24px;
            }

            .progress-track {
                height: 3px;
            }

            .blend-info {
                gap: 10px;
            }

            .blend-avatar {
                width: 36px;
                height: 36px;
            }

            .blend-avatar svg {
                width: 18px;
                height: 18px;
            }

            .blend-name {
                font-size: 13px;
            }

            .blend-participants-count {
                font-size: 10px;
            }

            .blend-actions-bar {
                flex-wrap: wrap;
                gap: 6px;
            }

            .btn-small {
                padding: 4px 8px;
                font-size: 10px;
            }

            .now-playing-cover {
                width: 48px;
                height: 48px;
            }

            .queue-item-blend {
                padding: 6px;
            }

            .now-playing-section,
            .queue-section-blend,
            .blend-search-section {
                margin: 0 10px 12px;
            }

            .modal-content {
                padding: 16px;
            }

            .modal-header {
                font-size: 14px;
            }

            .form-input,
            .blend-search-input {
                font-size: 12px;
            }
        }

        /* Touch optimization for all mobile devices */
        @media (hover: none) and (pointer: coarse) {

            .nav-item,
            .track-card,
            .icon-btn,
            .control-button,
            .btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                user-select: none;
                -webkit-user-select: none;
            }

            .track-card:active {
                background: #0f0f0f;
                transform: scale(0.98);
            }

            .icon-btn:active,
            .control-button:active {
                transform: scale(0.9);
            }

            .btn:active {
                transform: scale(0.98);
            }

            .progress-track {
                height: 10px;
                cursor: pointer;
                touch-action: none;
            }

            .progress-bar {
                pointer-events: none;
            }
        }


        @media (max-width: 480px) {
            .player-bar {
                bottom: calc(65px + env(safe-area-inset-bottom, 0px));
            }
        }

        @media (max-width: 360px) {
            .player-bar {
                bottom: calc(60px + env(safe-area-inset-bottom, 0px));
            }
        }
    </style>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/listenfreely.png">
    <meta name="theme-color" content="#000000">
    <script defer>
        // PWA install banner + service worker registration + auto-update
        (function(){
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

            // Create a simple install banner element (only shown in browser, not when PWA is installed)
            let deferredPrompt = null;
            function createInstallBanner() {
                const existing = document.getElementById('install-banner');
                if (existing) return existing;
                const banner = document.createElement('div');
                banner.id = 'install-banner';
                banner.style.position = 'fixed';
                banner.style.left = '12px';
                banner.style.right = '12px';
                banner.style.bottom = '84px';
                banner.style.zIndex = 2000;
                banner.style.background = '#0a0a0a';
                banner.style.border = '1px solid #1a1a1a';
                banner.style.padding = '12px';
                banner.style.borderRadius = '10px';
                banner.style.display = 'flex';
                banner.style.gap = '8px';
                banner.style.alignItems = 'center';
                banner.style.justifyContent = 'space-between';
                banner.style.boxShadow = '0 6px 18px rgba(0,0,0,0.6)';

                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.style.gap = '12px';

                const img = document.createElement('img');
                img.src = '/listenfreely.png';
                img.style.width = '48px';
                img.style.height = '48px';
                img.style.borderRadius = '8px';
                left.appendChild(img);

                const text = document.createElement('div');
                text.style.flex = '1';
                text.style.color = '#fafafa';
                text.innerHTML = '<div style="font-weight:600">Install ListenFreely</div><div style="font-size:12px;color:#888;margin-top:2px">Open quickly from your home screen and keep it updated</div>';
                left.appendChild(text);

                const actions = document.createElement('div');

                const installBtn = document.createElement('button');
                installBtn.innerText = 'Install';
                installBtn.style.marginRight = '8px';
                installBtn.className = 'btn btn-primary btn-small';
                installBtn.onclick = async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const choice = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    hideBanner();
                };

                const openBtn = document.createElement('button');
                openBtn.innerText = 'Open in App';
                openBtn.className = 'btn btn-secondary btn-small';
                openBtn.onclick = () => {
                    // If PWA is installed this will be a no-op; otherwise suggest reload
                    hideBanner();
                    try { window.location.href = window.location.href; } catch(e){}
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.innerText = 'Cancel';
                cancelBtn.className = 'btn btn-small';
                cancelBtn.onclick = hideBanner;

                actions.appendChild(installBtn);
                actions.appendChild(openBtn);
                actions.appendChild(cancelBtn);

                banner.appendChild(left);
                banner.appendChild(actions);
                document.body.appendChild(banner);
                return banner;
            }

            function showBanner() {
                if (isStandalone) return;
                const b = createInstallBanner();
                b.style.display = 'flex';
            }
            function hideBanner() {
                const b = document.getElementById('install-banner');
                if (!b) return;
                b.style.display = 'none';
            }

            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent automatic mini-infobar on mobile
                e.preventDefault();
                deferredPrompt = e;
                showBanner();
            });

            // Don't show install UI when already running as PWA
            if (isStandalone) hideBanner();

            // Register Service Worker and enable immediate updates
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', async () => {
                    try {
                        const registration = await navigator.serviceWorker.register('/service-worker.js', {scope:'/'});

                        // If there's an updated worker waiting, ask it to skipWaiting immediately
                        if (registration.waiting) {
                            registration.waiting.postMessage({type: 'SKIP_WAITING'});
                        }

                        // Listen for updates found in the future
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (!newWorker) return;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    // New content available â€” activate immediately
                                    if (navigator.serviceWorker.controller) {
                                        newWorker.postMessage({type: 'SKIP_WAITING'});
                                    }
                                }
                            });
                        });

                        // When the new service worker takes control, reload so user sees updated app
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            window.location.reload();
                        });
                    } catch (err) {
                        console.error('ServiceWorker registration failed:', err);
                    }
                });
            }
        })();
    </script>
</head>

<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">ListenFreely</div>
            <nav>
                <div class="nav-item active" data-view="search">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span>Search</span>
                </div>
                <div class="nav-item" data-view="recent">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Recently Played</span>
                </div>
                <div class="nav-item" data-view="liked">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                    <span>Liked Songs</span>
                </div>
                <div class="nav-item" data-view="blend">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Listen Together</span>
                </div>
            </nav>
        </aside>

        <main class="main" id="mainContent">
            <div id="searchView">
                <div class="search-bar">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" class="search-input" placeholder="Search songs, artists, albums..."
                        id="searchInput">
                </div>
                <div id="searchResults"></div>
            </div>

            <div id="recentView" style="display: none;">
                <h2 class="section-title">Recently Played</h2>
                <div class="tracks-grid" id="recentTracks"></div>
            </div>

            <div id="likedView" style="display: none;">
                <h2 class="section-title">Liked Songs</h2>
                <div class="tracks-grid" id="likedTracks"></div>
            </div>

            <div id="blendView" style="display: none;">
                <div class="blend-container">
                    <div id="blendInitial">
                        <h2 class="section-title">Listen Together</h2>
                        <div
                            style="background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; padding: 40px; text-align: center;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                style="width: 64px; height: 64px; margin: 0 auto 16px; opacity: 0.3;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Start Listening Together
                            </div>
                            <div style="font-size: 14px; color: #888; margin-bottom: 24px;">Create a session or join
                                your friends</div>
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button class="btn btn-primary" id="createBlendBtn">Create Session</button>
                                <button class="btn btn-secondary" id="joinBlendBtn">Join Session</button>
                            </div>
                        </div>
                    </div>

                    <div id="blendActive" style="display: none;">
                        <div class="blend-top-bar">
                            <div class="blend-info">
                                <div class="blend-avatar" id="blendAvatar">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    <input type="file" id="blendAvatarInput" accept="image/*" style="display: none;">
                                </div>
                                <div class="blend-details">
                                    <div class="blend-name-edit">
                                        <div class="blend-name" id="blendNameDisplay">My Blend</div>
                                        <button class="icon-btn" id="editBlendNameBtn" style="padding: 4px;">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                                style="width: 14px; height: 14px;">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="blend-participants-count">
                                        <div class="participants-dot"></div>
                                        <span id="participantCount">1 listener</span>
                                    </div>
                                </div>
                            </div>
                            <div class="blend-actions-bar">
                                <button class="icon-btn" id="shareBlendBtn" title="Share">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                    </svg>
                                </button>
                                <button class="btn btn-danger btn-small" id="leaveBlendBtn">Leave</button>
                            </div>
                        </div>

                        <div class="now-playing-section" id="nowPlayingSection" style="display: none;">
                            <div class="section-label">Currently Playing</div>
                            <div class="now-playing-track">
                                <img class="now-playing-cover" id="nowPlayingCover" src="" alt="">
                                <div class="now-playing-info">
                                    <div class="now-playing-title" id="nowPlayingTitle">â€”</div>
                                    <div class="now-playing-artist" id="nowPlayingArtist">â€”</div>
                                </div>
                            </div>
                        </div>

                        <div class="queue-section-blend">
                            <div class="section-label">Coming Next</div>
                            <div id="comingNextList"></div>
                        </div>

                        <div class="blend-search-section">
                            <div class="section-label">Add Songs</div>
                            <div class="blend-search-bar">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" class="blend-search-input" id="blendSearchInput"
                                    placeholder="Search for songs to add...">
                            </div>
                            <div class="blend-search-results" id="blendSearchResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="joinBlendModal">
        <div class="modal-content">
            <div class="modal-header">Join Listen Together Session</div>
            <div class="form-group">
                <label class="form-label">Enter Blend ID or paste share link</label>
                <input type="text" class="form-input" id="joinBlendInput" placeholder="blend-123456 or full URL">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelJoinBlendBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmJoinBlendBtn">Join</button>
            </div>
        </div>
    </div>

    <div class="player-bar">
        <div class="player-content">
            <div class="player-track">
                <div class="player-cover placeholder" id="playerCoverWrapper">
                    <img id="playerCover" src="" alt=""
                        style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" id="placeholderIcon">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                </div>
                <div class="player-info">
                    <div class="player-title" id="playerTitle">No track selected</div>
                    <div class="player-artist" id="playerArtist">
                        Select a song to play
                        <span class="source-badge" id="sourceBadge" style="display: none;"></span>
                    </div>
                </div>
            </div>

            <div class="player-controls">
                <div class="controls-buttons">
                    <button class="control-button" id="prevBtn">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
                        </svg>
                    </button>
                    <button class="control-button play-btn" id="playBtn">
                        <svg fill="currentColor" viewBox="0 0 24 24" id="playIcon">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                        <svg fill="currentColor" viewBox="0 0 24 24" id="pauseIcon" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                        </svg>
                    </button>
                    <button class="control-button" id="nextBtn">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                        </svg>
                    </button>
                </div>
                <div class="progress-wrapper">
                    <span class="time-label" id="currentTime">0:00</span>
                    <div class="progress-track" id="progressTrack">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <span class="time-label" id="totalTime">0:00</span>
                </div>
            </div>

            <div class="player-extra"></div>
        </div>
    </div>

    <audio id="audio" crossorigin="anonymous"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <script>
        const API_SOURCES = [
            {
                name: 'JioSaavn',
                displayName: 'JioSaavn',
                search: async (q) => {
                    const res = await fetch(`https://jiosaavn-api-privatecvc2.vercel.app/search/songs?query=${encodeURIComponent(q)}&page=1&limit=20`);
                    const data = await res.json();
                    return data.data.results.map(t => ({
                        id: t.id,
                        name: t.name,
                        artists: t.primaryArtists,
                        album: t.album?.name || 'Unknown',
                        cover: t.image?.[2]?.link || t.image?.[1]?.link || '',
                        duration: t.duration * 1000,
                        downloadUrl: t.downloadUrl?.[4]?.link || t.downloadUrl?.[3]?.link || t.downloadUrl?.[2]?.link,
                        source: 'JioSaavn'
                    }));
                },
                download: async (track) => track.downloadUrl
            }
        ];

        const state = {
            currentTrack: null,
            playlist: [],
            allTracks: [],
            currentIndex: -1,
            isPlaying: false,
            currentView: 'search',
            recentTracks: JSON.parse(localStorage.getItem('recentTracks') || '[]'),
            likedTracks: JSON.parse(localStorage.getItem('likedTracks') || '[]'),
            blend: {
                active: false,
                isHost: false,
                id: null,
                name: '',
                avatar: null,
                peers: new Map(),
                queue: [],
                participants: []
            }
        };

        let peer = null;

        const el = {
            searchInput: document.getElementById('searchInput'),
            searchResults: document.getElementById('searchResults'),
            recentTracks: document.getElementById('recentTracks'),
            likedTracks: document.getElementById('likedTracks'),
            audio: document.getElementById('audio'),
            playBtn: document.getElementById('playBtn'),
            playIcon: document.getElementById('playIcon'),
            pauseIcon: document.getElementById('pauseIcon'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            progressBar: document.getElementById('progressBar'),
            progressTrack: document.getElementById('progressTrack'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime'),
            playerCover: document.getElementById('playerCover'),
            playerCoverWrapper: document.getElementById('playerCoverWrapper'),
            placeholderIcon: document.getElementById('placeholderIcon'),
            playerTitle: document.getElementById('playerTitle'),
            playerArtist: document.getElementById('playerArtist'),
            sourceBadge: document.getElementById('sourceBadge'),
            createBlendBtn: document.getElementById('createBlendBtn'),
            joinBlendBtn: document.getElementById('joinBlendBtn'),
            leaveBlendBtn: document.getElementById('leaveBlendBtn'),
            blendInitial: document.getElementById('blendInitial'),
            blendActive: document.getElementById('blendActive'),
            blendAvatar: document.getElementById('blendAvatar'),
            blendAvatarInput: document.getElementById('blendAvatarInput'),
            blendNameDisplay: document.getElementById('blendNameDisplay'),
            editBlendNameBtn: document.getElementById('editBlendNameBtn'),
            participantCount: document.getElementById('participantCount'),
            shareBlendBtn: document.getElementById('shareBlendBtn'),
            nowPlayingSection: document.getElementById('nowPlayingSection'),
            nowPlayingCover: document.getElementById('nowPlayingCover'),
            nowPlayingTitle: document.getElementById('nowPlayingTitle'),
            nowPlayingArtist: document.getElementById('nowPlayingArtist'),
            comingNextList: document.getElementById('comingNextList'),
            blendSearchInput: document.getElementById('blendSearchInput'),
            blendSearchResults: document.getElementById('blendSearchResults'),
            joinBlendModal: document.getElementById('joinBlendModal'),
            joinBlendInput: document.getElementById('joinBlendInput'),
            confirmJoinBlendBtn: document.getElementById('confirmJoinBlendBtn'),
            cancelJoinBlendBtn: document.getElementById('cancelJoinBlendBtn')
        };

        function formatTime(s) {
            if (!s || isNaN(s)) return '0:00';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }

        async function search(q) {
            if (!q.trim()) return;
            const results = {};
            state.allTracks = [];

            try {
                const saavnApi = API_SOURCES[0];
                const tracks = await saavnApi.search(q);
                if (tracks.length > 0) {
                    results[saavnApi.displayName] = tracks;
                    renderSearchResults(results);
                }
            } catch (e) {
                console.error('Search failed:', e);
            }
        }

        function renderSearchResults(results) {
            const sources = Object.keys(results);
            if (sources.length === 0) {
                el.searchResults.innerHTML = '<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg><p>No results found</p></div>';
                return;
            }

            let html = '';
            sources.forEach(source => {
                const tracks = results[source];
                html += `
                    <div class="api-section">
                        <div class="api-header">
                            <span class="api-name">${source}</span>
                            <span class="api-count">${tracks.length} tracks</span>
                        </div>
                        <div class="tracks-grid">
                            ${tracks.map((t, i) => {
                    const globalIndex = state.allTracks.length;
                    state.allTracks.push(t);
                    return `
                                    <div class="track-card" data-index="${globalIndex}">
                                        <img class="track-cover" src="${t.cover}">
                                        <div class="track-details">
                                            <div class="track-title">${t.name}</div>
                                            <div class="track-subtitle">${t.artists}</div>
                                        </div>
                                        <div class="track-actions">
                                            <button class="icon-btn like-btn ${isLiked(t.id) ? 'active' : ''}" data-id="${t.id}">
                                                <svg fill="${isLiked(t.id) ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                                </svg>
                                            </button>
                                            ${state.blend.active ?
                            `<button class="icon-btn" onclick="addToBlendQueue(${globalIndex})">
                                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                                    </svg>
                                                </button>` : ''
                        }
                                        </div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            });

            el.searchResults.innerHTML = html;
            state.playlist = state.allTracks;

            el.searchResults.querySelectorAll('.track-card').forEach(card => {
                card.addEventListener('click', e => {
                    if (!e.target.closest('.icon-btn')) {
                        playTrack(parseInt(card.dataset.index));
                    }
                });
            });

            el.searchResults.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    toggleLike(btn.dataset.id);
                });
            });
        }

        function renderTracks(tracks, container) {
            if (!tracks.length) {
                container.innerHTML = '<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg><p>No tracks found</p></div>';
                return;
            }

            container.innerHTML = tracks.map((t, i) => `
                <div class="track-card" data-index="${i}">
                    <img class="track-cover" src="${t.cover}">
                    <div class="track-details">
                        <div class="track-title">${t.name}</div>
                        <div class="track-subtitle">${t.artists}</div>
                    </div>
                    <div class="track-actions">
                        <button class="icon-btn like-btn ${isLiked(t.id) ? 'active' : ''}" data-id="${t.id}">
                            <svg fill="${isLiked(t.id) ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.track-card').forEach(card => {
                card.addEventListener('click', e => {
                    if (!e.target.closest('.icon-btn')) {
                        playTrack(parseInt(card.dataset.index));
                    }
                });
            });

            container.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    toggleLike(btn.dataset.id);
                });
            });
        }

        function isLiked(id) {
            return state.likedTracks.some(t => t.id === id);
        }

        function toggleLike(id) {
            const track = state.playlist.find(t => t.id === id);
            if (!track) return;

            const index = state.likedTracks.findIndex(t => t.id === id);
            if (index > -1) {
                state.likedTracks.splice(index, 1);
            } else {
                state.likedTracks.unshift(track);
            }
            localStorage.setItem('likedTracks', JSON.stringify(state.likedTracks));
            // Update UI across all lists immediately (search, recent, liked, blend)
            updateLikeButtons();

            if (state.currentView === 'search') {
                search(el.searchInput.value);
            } else if (state.currentView === 'liked') {
                renderTracks(state.likedTracks, el.likedTracks);
            } else if (state.currentView === 'recent') {
                renderTracks(state.recentTracks, el.recentTracks);
            } else if (state.currentView === 'blend') {
                // update blend-related lists if present
                updateQueueUI();
                if (el.blendSearchResults) {
                    // blend search results rendered separately - re-run small update
                    document.querySelectorAll('#blendSearchResults .like-btn').forEach(btn => {
                        const btnId = btn.dataset.id;
                        if (isLiked(btnId)) btn.classList.add('active'); else btn.classList.remove('active');
                    });
                }
            }
        }

        // Update all like buttons across the UI to reflect current liked state
        function updateLikeButtons() {
            document.querySelectorAll('.like-btn').forEach(btn => {
                const id = btn.dataset.id;
                const svg = btn.querySelector('svg');
                if (isLiked(id)) {
                    btn.classList.add('active');
                    if (svg) svg.setAttribute('fill', 'currentColor');
                } else {
                    btn.classList.remove('active');
                    if (svg) svg.setAttribute('fill', 'none');
                }
            });
        }

        function addToRecent(track) {
            state.recentTracks = [track, ...state.recentTracks.filter(t => t.id !== track.id)].slice(0, 50);
            localStorage.setItem('recentTracks', JSON.stringify(state.recentTracks));
        }

        async function playTrack(index, skipBroadcast = false) {
            if (index < 0 || index >= state.playlist.length) return;

            state.currentIndex = index;
            state.currentTrack = state.playlist[index];

            try {
                const url = state.currentTrack.downloadUrl;
                el.audio.src = url;

                if (state.currentTrack.cover) {
                    el.playerCover.src = state.currentTrack.cover;
                    el.playerCover.style.display = 'block';
                    el.placeholderIcon.style.display = 'none';
                    el.playerCoverWrapper.classList.remove('placeholder');
                } else {
                    el.playerCover.style.display = 'none';
                    el.placeholderIcon.style.display = 'block';
                    el.playerCoverWrapper.classList.add('placeholder');
                }

                el.playerTitle.textContent = state.currentTrack.name;
                el.playerArtist.textContent = state.currentTrack.artists;

                if (state.currentTrack.source) {
                    el.sourceBadge.textContent = state.currentTrack.source;
                    el.sourceBadge.style.display = 'inline-block';
                } else {
                    el.sourceBadge.style.display = 'none';
                }

                await el.audio.play();
                state.isPlaying = true;
                el.playIcon.style.display = 'none';
                el.pauseIcon.style.display = 'block';

                addToRecent(state.currentTrack);

                if (state.blend.active) {
                    updateQueueUI();
                    updateNowPlaying();
                    if (!skipBroadcast) {
                        broadcastToAll({
                            type: 'play-track',
                            index,
                            seek: 0
                        });
                    }
                }
            } catch (e) {
                console.error('Play failed:', e);
            }
        }

        async function playTrackSilent(index) {
            await playTrack(index, true);
        }

        el.playBtn.addEventListener('click', () => {
            if (state.isPlaying) {
                el.audio.pause();
                state.isPlaying = false;
                el.playIcon.style.display = 'block';
                el.pauseIcon.style.display = 'none';
                if (state.blend.active) {
                    if (state.blend.isHost) {
                        broadcastToAll({ type: 'play-pause', playing: false, time: el.audio.currentTime, timestamp: Date.now() });
                    } else {
                        // ask host to pause at this time
                        sendToHost({ type: 'play-toggle-request', playing: false, time: el.audio.currentTime, timestamp: Date.now(), currentIndex: state.currentIndex });
                    }
                }
            } else {
                el.audio.play();
                state.isPlaying = true;
                el.playIcon.style.display = 'none';
                el.pauseIcon.style.display = 'block';
                if (state.blend.active) {
                    if (state.blend.isHost) {
                        broadcastToAll({ type: 'play-pause', playing: true, time: el.audio.currentTime, timestamp: Date.now() });
                    } else {
                        // ask host to play this track/time
                        sendToHost({ type: 'play-toggle-request', playing: true, time: el.audio.currentTime, timestamp: Date.now(), currentIndex: state.currentIndex });
                    }
                }
            }
        });

        el.prevBtn.addEventListener('click', () => {
            if (state.currentIndex > 0) {
                playTrack(state.currentIndex - 1);
            }
        });

        el.nextBtn.addEventListener('click', () => {
            if (state.currentIndex < state.playlist.length - 1) {
                playTrack(state.currentIndex + 1);
            }
        });

        el.audio.addEventListener('timeupdate', () => {
            const p = (el.audio.currentTime / el.audio.duration) * 100;
            el.progressBar.style.width = `${p || 0}%`;
            el.currentTime.textContent = formatTime(el.audio.currentTime);
        });

        el.audio.addEventListener('loadedmetadata', () => {
            el.totalTime.textContent = formatTime(el.audio.duration);
        });

        el.audio.addEventListener('ended', () => {
            if (state.currentIndex < state.playlist.length - 1) {
                if (state.blend.active) {
                    // Only host triggers next track to avoid race conditions
                    if (state.blend.isHost) {
                        playTrack(state.currentIndex + 1);
                    }
                } else {
                    playTrack(state.currentIndex + 1);
                }
            } else {
                state.isPlaying = false;
                el.playIcon.style.display = 'block';
                el.pauseIcon.style.display = 'none';
            }
        });

        let seekTimeout;
        el.progressTrack.addEventListener('click', e => {
            const rect = el.progressTrack.getBoundingClientRect();
            const p = (e.clientX - rect.left) / rect.width;
            const seekTime = p * el.audio.duration;
            el.audio.currentTime = seekTime;

            // Sync seek with peers
            if (state.blend.active) {
                clearTimeout(seekTimeout);
                seekTimeout = setTimeout(() => {
                    if (state.blend.isHost) {
                        broadcastToAll({ type: 'seek', time: seekTime, timestamp: Date.now() });
                    } else {
                        sendToHost({ type: 'seek-request', time: seekTime, timestamp: Date.now(), currentIndex: state.currentIndex });
                    }
                }, 100);
            }
        });

        let searchTimeout;
        el.searchInput.addEventListener('input', e => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query) {
                state.allTracks = [];
                searchTimeout = setTimeout(() => search(query), 500);
            } else {
                el.searchResults.innerHTML = '';
            }
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                const view = item.dataset.view;
                state.currentView = view;

                document.getElementById('searchView').style.display = view === 'search' ? 'block' : 'none';
                document.getElementById('recentView').style.display = view === 'recent' ? 'block' : 'none';
                document.getElementById('likedView').style.display = view === 'liked' ? 'block' : 'none';
                document.getElementById('blendView').style.display = view === 'blend' ? 'block' : 'none';

                if (view === 'recent') {
                    state.playlist = state.recentTracks;
                    renderTracks(state.recentTracks, el.recentTracks);
                } else if (view === 'liked') {
                    state.playlist = state.likedTracks;
                    renderTracks(state.likedTracks, el.likedTracks);
                } else if (view === 'blend') {
                    checkBlendUrl();
                }
            });
        });

        // WebRTC Blend
        function generateBlendId() {
            return 'blend-' + Math.random().toString(36).substr(2, 9);
        }

        function checkBlendUrl() {
            const params = new URLSearchParams(window.location.search);
            const blendId = params.get('blend');
            if (blendId && !state.blend.active) {
                el.joinBlendInput.value = blendId;
                el.joinBlendModal.classList.add('active');
            }
        }

        function createBlendSession() {
            const blendId = generateBlendId();
            state.blend.id = blendId;
            state.blend.isHost = true;
            state.blend.active = true;
            state.blend.participants = [{ id: 'host', name: 'You (Host)' }];
            state.blend.name = 'My Blend';

            window.history.pushState({}, '', `?blend=${blendId}`);

            el.blendInitial.style.display = 'none';
            el.blendActive.style.display = 'block';

            updateBlendUI();
            initializePeer(blendId);
            startHeartbeat();
        }

        function joinBlendSession(blendId) {
            state.blend.id = blendId;
            state.blend.isHost = false;
            state.blend.active = true;
            state.blend.participants = [{ id: 'peer', name: 'You' }];
            state.blend.name = 'Shared Blend';

            window.history.pushState({}, '', `?blend=${blendId}`);

            el.blendInitial.style.display = 'none';
            el.blendActive.style.display = 'block';

            updateBlendUI();
            connectToPeer(blendId);
            startHeartbeat();
        }

        function initializePeer(blendId) {
            const peerId = 'listenfreely-' + blendId;

            peer = new Peer(peerId, {
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                console.log('Session created:', id);
                updateParticipants();
            });

            peer.on('connection', (conn) => {
                console.log('Incoming connection');
                setupPeerConnection(conn);
            });

            peer.on('error', (error) => {
                console.error('Peer error:', error);
                if (error.type === 'unavailable-id') {
                    peer.destroy();
                    connectToPeer(blendId);
                }
            });
        }

        function connectToPeer(blendId) {
            const guestId = 'listenfreely-guest-' + Math.random().toString(36).substr(2, 9);

            peer = new Peer(guestId, {
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                console.log('Connected as guest:', id);

                const hostPeerId = 'listenfreely-' + blendId;
                setTimeout(() => {
                    const conn = peer.connect(hostPeerId);
                    setupPeerConnection(conn);
                }, 1000);
            });

            peer.on('connection', (conn) => {
                setupPeerConnection(conn);
            });
        }

        function setupPeerConnection(conn) {
            const peerInfo = {
                id: conn.peer,
                connection: conn,
                isConnected: false
            };

            conn.on('open', () => {
                console.log('Connection established');
                peerInfo.isConnected = true;
                state.blend.peers.set(conn.peer, peerInfo);

                state.blend.participants.push({
                    id: conn.peer,
                    name: state.blend.isHost ? 'Listener' : 'Host'
                });
                updateParticipants();

                // If host, broadcast updated participants to everyone
                if (state.blend.isHost) {
                    broadcastToAll({ type: 'participants-update', participants: state.blend.participants });
                }

                if (!state.blend.isHost) {
                    sendToPeer(conn, { type: 'sync-request' });
                }
            });

            conn.on('data', (data) => {
                handlePeerMessage(data, conn);
            });

            conn.on('close', () => {
                console.log('Connection closed');
                state.blend.peers.delete(conn.peer);
                state.blend.participants = state.blend.participants.filter(p => p.id !== conn.peer);
                updateParticipants();
            });
        }

        function handlePeerMessage(data, conn) {
            console.log('Received:', data);

            switch (data.type) {
                case 'heartbeat':
                    if (data.heartbeat) {
                        const hb = data.heartbeat;
                        // if this heartbeat comes from the host and we're a guest, request sync when out-of-sync
                        if (hb.isHost && !state.blend.isHost) {
                            const timeDiff = Math.abs((el.audio ? el.audio.currentTime : 0) - hb.currentTime);
                            const indexDiff = state.currentIndex !== hb.currentIndex;
                            const playingDiff = state.isPlaying !== hb.isPlaying;
                            if (timeDiff > 1 || indexDiff || playingDiff) {
                                // request authoritative state from host
                                sendToPeer(conn, { type: 'sync-request' });
                            }
                        }
                        // if we're host, we can monitor other peers' heartbeats (could add lastSeen tracking)
                    }
                    break;
                case 'sync-request':
                    if (state.blend.isHost) {
                        sendToPeer(conn, {
                            type: 'sync-response',
                            queue: state.blend.queue,
                            currentIndex: state.currentIndex,
                            currentTime: el.audio.currentTime,
                            isPlaying: state.isPlaying,
                            blendName: state.blend.name,
                            blendAvatar: state.blend.avatar
                        });
                    }
                    break;

                case 'play-toggle-request':
                    // only host should handle play requests
                    if (state.blend.isHost) {
                        const idx = typeof data.currentIndex === 'number' ? data.currentIndex : state.currentIndex;
                        if (idx !== state.currentIndex) {
                            playTrackSilent(idx);
                        }
                        // set time
                        try { if (typeof data.time === 'number') el.audio.currentTime = data.time; } catch (e) {}
                        if (data.playing) {
                            el.audio.play().catch(() => {});
                            state.isPlaying = true;
                        } else {
                            el.audio.pause();
                            state.isPlaying = false;
                        }
                        // broadcast authoritative state-update immediately
                        const st = { currentIndex: state.currentIndex, isPlaying: state.isPlaying, currentTime: el.audio.currentTime, queue: state.blend.queue, blendName: state.blend.name, blendAvatar: state.blend.avatar, participants: state.blend.participants, timestamp: Date.now() };
                        broadcastToAll({ type: 'state-update', state: st });
                    }
                    break;

                case 'seek-request':
                    if (state.blend.isHost && typeof data.time === 'number') {
                        try { el.audio.currentTime = data.time; } catch (e) {}
                        // broadcast authoritative seek
                        broadcastToAll({ type: 'seek', time: data.time, timestamp: Date.now() });
                    }
                    break;

                case 'sync-response':
                    state.blend.queue = data.queue || [];
                    state.playlist = state.blend.queue;

                    if (data.blendName) {
                        state.blend.name = data.blendName;
                        el.blendNameDisplay.textContent = data.blendName;
                    }
                    if (data.blendAvatar) {
                        state.blend.avatar = data.blendAvatar;
                        el.blendAvatar.innerHTML = `<img src="${data.blendAvatar}" alt="Avatar">`;
                    }

                    updateQueueUI();

                    if (data.queue && data.queue.length > 0 && data.currentIndex >= 0) {
                        playTrack(data.currentIndex);
                        setTimeout(() => {
                            el.audio.currentTime = data.currentTime || 0;
                            if (!data.isPlaying) {
                                el.audio.pause();
                                state.isPlaying = false;
                                el.playIcon.style.display = 'block';
                                el.pauseIcon.style.display = 'none';
                            }
                        }, 500);
                    }
                    break;

                case 'state-update':
                    if (data.state && !state.blend.isHost) {
                        const s = data.state;
                        state.blend.queue = s.queue || [];
                        state.playlist = state.blend.queue;
                        if (s.blendName) {
                            state.blend.name = s.blendName;
                            el.blendNameDisplay.textContent = s.blendName;
                        }
                        if (s.blendAvatar) {
                            state.blend.avatar = s.blendAvatar;
                            el.blendAvatar.innerHTML = `<img src="${s.blendAvatar}" alt="Avatar">`;
                        }
                        if (Array.isArray(s.participants)) {
                            state.blend.participants = s.participants;
                            updateParticipants();
                        }

                        updateQueueUI();

                        // Sync playback with host using timestamp compensation
                        const now = Date.now();
                        const latency = (now - (s.timestamp || now)) / 1000; // seconds
                        const targetTime = (s.currentTime || 0) + latency;

                        if (s.currentIndex !== undefined && s.currentIndex !== state.currentIndex) {
                            playTrack(s.currentIndex);
                        }

                        setTimeout(() => {
                            try {
                                el.audio.currentTime = Math.max(0, Math.min(el.audio.duration || Infinity, targetTime));
                            } catch (e) { }
                            if (s.isPlaying) {
                                el.audio.play().catch(() => { });
                                state.isPlaying = true;
                                el.playIcon.style.display = 'none';
                                el.pauseIcon.style.display = 'block';
                            } else {
                                el.audio.pause();
                                state.isPlaying = false;
                                el.playIcon.style.display = 'block';
                                el.pauseIcon.style.display = 'none';
                            }
                        }, 300);
                    }
                    break;

                case 'queue-add':
                    state.blend.queue.push(data.track);
                    state.playlist = state.blend.queue;
                    updateQueueUI();

                    // Only auto-play if host and no current track
                    if (state.blend.isHost && state.blend.queue.length === 1 && !state.currentTrack) {
                        setTimeout(() => {
                            playTrack(0);
                            broadcastToAll({
                                type: 'force-play',
                                index: 0,
                                timestamp: Date.now()
                            });
                        }, 300);
                    }
                    break;

                case 'play-track':
                    if (!state.isPlaying || state.currentIndex !== data.index) {
                        playTrackSilent(data.index);
                        if (data.seek !== undefined) {
                            setTimeout(() => {
                                el.audio.currentTime = data.seek;
                            }, 300);
                        }
                    }
                    break;

                case 'force-play':
                    // Force play from host, ignore local state
                    playTrackSilent(data.index);
                    break;

                case 'play-pause':
                    if (data.playing && !state.isPlaying) {
                        el.audio.play().catch(e => console.log('Play failed:', e));
                        state.isPlaying = true;
                        el.playIcon.style.display = 'none';
                        el.pauseIcon.style.display = 'block';
                    } else if (!data.playing && state.isPlaying) {
                        el.audio.pause();
                        state.isPlaying = false;
                        el.playIcon.style.display = 'block';
                        el.pauseIcon.style.display = 'none';
                    }
                    break;

                case 'seek':
                    if (Math.abs(el.audio.currentTime - data.time) > 1) {
                        el.audio.currentTime = data.time;
                    }
                    break;

                case 'blend-metadata-update':
                    if (data.name) {
                        state.blend.name = data.name;
                        el.blendNameDisplay.textContent = data.name;
                    }
                    if (data.avatar) {
                        state.blend.avatar = data.avatar;
                        el.blendAvatar.innerHTML = `<img src="${data.avatar}" alt="Avatar">`;
                    }
                    break;
                case 'participants-update':
                    if (Array.isArray(data.participants)) {
                        state.blend.participants = data.participants;
                        updateParticipants();
                    }
                    break;
                case 'queue-reorder':
                    if (Array.isArray(data.queue)) {
                        state.blend.queue = data.queue;
                        state.playlist = state.blend.queue;
                        updateQueueUI();
                    }
                    break;
                case 'queue-reorder-request':
                    // Only host should process requests to avoid conflicts
                    if (state.blend.isHost && typeof data.from === 'number' && typeof data.to === 'number') {
                        const fromIdx = data.from;
                        const toIdx = data.to;
                        if (fromIdx >= 0 && fromIdx < state.blend.queue.length && toIdx >= 0 && toIdx <= state.blend.queue.length) {
                            const tr = state.blend.queue.splice(fromIdx, 1)[0];
                            state.blend.queue.splice(toIdx, 0, tr);
                            // broadcast authoritative queue to all peers
                            broadcastToAll({ type: 'queue-reorder', queue: state.blend.queue });
                        }
                    }
                    break;
                case 'queue-remove-request':
                    if (state.blend.isHost && typeof data.index === 'number') {
                        const idx = data.index;
                        if (idx >= 0 && idx < state.blend.queue.length) {
                            state.blend.queue.splice(idx, 1);
                            state.playlist = state.blend.queue;
                            broadcastToAll({ type: 'queue-remove', index: idx });
                            updateQueueUI();
                        }
                    }
                    break;

                case 'queue-remove':
                    if (typeof data.index === 'number') {
                        const idx = data.index;
                        if (idx >= 0 && idx < state.blend.queue.length) {
                            state.blend.queue.splice(idx, 1);
                            state.playlist = state.blend.queue;
                            updateQueueUI();
                        }
                    }
                    break;
            }
        }

        function sendToPeer(conn, data) {
            if (conn && conn.open) {
                try {
                    conn.send(data);
                    console.log('Sent:', data.type);
                } catch (error) {
                    console.error('Error sending:', error);
                }
            }
        }

        function getHostConnection() {
            if (!state.blend || !state.blend.id) return null;
            const hostId = 'listenfreely-' + state.blend.id;
            // Try direct lookup first
            const direct = state.blend.peers.get(hostId);
            if (direct && direct.connection && direct.isConnected) return direct.connection;
            // Fallback: search peers map for a peer whose id matches hostId or appears to be the host
            for (const [key, info] of state.blend.peers.entries()) {
                if (!info || !info.connection) continue;
                if (info.id === hostId) return info.connection;
                // some peers may use different ids; treat the peer that registered as host as candidate
                if (key === hostId) return info.connection;
            }
            // Last resort: return the first connected peer (best-effort)
            for (const info of state.blend.peers.values()) {
                if (info && info.connection && info.isConnected) return info.connection;
            }
            return null;
        }

        function sendToHost(data) {
            const conn = getHostConnection();
            if (conn && conn.open) {
                sendToPeer(conn, data);
                return true;
            }
            // if host not found, try broadcasting as fallback
            try {
                broadcastToAll(data);
                return true;
            } catch (e) {
                console.warn('sendToHost fallback failed', e);
            }
            return false;
        }

        // Heartbeat: periodically broadcast local state to peers
        let heartbeatInterval = null;
        function startHeartbeat() {
            if (heartbeatInterval) return;
            heartbeatInterval = setInterval(() => {
                if (!state.blend.active) return;
                const timestamp = Date.now();
                if (state.blend.isHost) {
                    // host sends authoritative state updates periodically
                    const st = {
                        currentIndex: state.currentIndex,
                        isPlaying: !!state.isPlaying,
                        currentTime: el.audio ? el.audio.currentTime : 0,
                        queue: state.blend.queue,
                        blendName: state.blend.name,
                        blendAvatar: state.blend.avatar,
                        participants: state.blend.participants,
                        timestamp
                    };
                    broadcastToAll({ type: 'state-update', state: st });
                } else {
                    const hb = {
                        isHost: !!state.blend.isHost,
                        currentIndex: state.currentIndex,
                        isPlaying: !!state.isPlaying,
                        currentTime: el.audio ? el.audio.currentTime : 0,
                        queueLength: state.blend.queue.length,
                        blendName: state.blend.name,
                        blendAvatar: state.blend.avatar,
                        participants: state.blend.participants,
                        timestamp
                    };
                    broadcastToAll({ type: 'heartbeat', heartbeat: hb });
                }
            }, 2000);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        function broadcastToAll(data) {
            console.log('Broadcasting:', data.type);
            state.blend.peers.forEach(peerInfo => {
                if (peerInfo.isConnected) {
                    sendToPeer(peerInfo.connection, data);
                }
            });
        }

        function updateParticipants() {
            const count = state.blend.participants.length;
            el.participantCount.textContent = `${count} listener${count !== 1 ? 's' : ''}`;
        }

        function leaveBlendSession() {
            state.blend.peers.forEach(peerInfo => {
                if (peerInfo.connection) {
                    try {
                        peerInfo.connection.close();
                    } catch (e) { }
                }
            });

            if (peer) {
                try {
                    peer.destroy();
                } catch (e) { }
                peer = null;
            }

            state.blend.active = false;
            state.blend.isHost = false;
            state.blend.id = null;
            state.blend.peers.clear();
            state.blend.queue = [];
            state.blend.participants = [];

            window.history.pushState({}, '', window.location.pathname);

            el.blendActive.style.display = 'none';
            el.blendInitial.style.display = 'block';
            stopHeartbeat();
        }

        function updateBlendUI() {
            el.blendNameDisplay.textContent = state.blend.name || 'My Blend';
            updateParticipants();
            updateQueueUI();
            updateNowPlaying();
        }

        function updateNowPlaying() {
            if (state.currentTrack) {
                el.nowPlayingSection.style.display = 'block';
                el.nowPlayingCover.src = state.currentTrack.cover || '';
                el.nowPlayingTitle.textContent = state.currentTrack.name;
                el.nowPlayingArtist.textContent = state.currentTrack.artists;
            } else {
                el.nowPlayingSection.style.display = 'none';
            }
        }

        function updateQueueUI() {
            const upcomingTracks = state.blend.queue.slice(state.currentIndex + 1);

            if (!upcomingTracks.length) {
                el.comingNextList.innerHTML = '<div class="empty-queue"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg><p>No upcoming tracks</p></div>';
                return;
            }

            el.comingNextList.innerHTML = upcomingTracks.map((track, index) => {
                return `
                    <div class="queue-item-blend">
                        <div class="drag-handle">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 3h2v2H9V3zm0 4h2v2H9V7zm0 4h2v2H9v-2zm0 4h2v2H9v-2zm0 4h2v2H9v-2zM13 3h2v2h-2V3zm0 4h2v2h-2V7zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2z"/>
                            </svg>
                        </div>
                        <button class="icon-btn remove-btn" title="Remove" data-id="${track.id}">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <img class="queue-item-cover" src="${track.cover}">
                        <div class="queue-item-info">
                            <div class="queue-item-title">${track.name}</div>
                            <div class="queue-item-artist">${track.artists}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Make queue items draggable and support reordering
            const parent = el.comingNextList;
            parent.querySelectorAll('.queue-item-blend').forEach((item, i) => {
                item.dataset.index = i;
                // enable HTML5 drag on desktop
                item.setAttribute('draggable', 'true');

                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', i);
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    // normalize indices after drag end
                    parent.querySelectorAll('.queue-item-blend').forEach((it, idx) => it.dataset.index = idx);
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = parent.querySelector('.dragging');
                    if (!dragging || dragging === item) return;
                    const from = parseInt(dragging.dataset.index, 10);
                    const to = parseInt(item.dataset.index, 10);
                    // visual re-order in DOM while dragging
                    if (from < to) parent.insertBefore(dragging, item.nextSibling);
                    else parent.insertBefore(dragging, item);
                    parent.querySelectorAll('.queue-item-blend').forEach((it, idx) => it.dataset.index = idx);
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
                    const to = parseInt(item.dataset.index, 10);
                    if (isNaN(from) || isNaN(to) || from === to) return;
                    // identify the track id from the upcoming list (relative indices)
                    const upcoming = state.blend.queue.slice(state.currentIndex + 1);
                    const track = upcoming[from];
                    if (!track) return;

                    // optimistic local reorder in upcoming list
                    const absFrom = state.blend.queue.findIndex(t => t.id === track.id);
                    let absTo = state.currentIndex + 1 + to;
                    if (absFrom === -1) return;
                    const moved = state.blend.queue.splice(absFrom, 1)[0];
                    // adjust absTo if removal before insertion changed indices
                    if (absFrom < absTo) absTo = Math.max(state.currentIndex + 1, absTo - 1);
                    state.blend.queue.splice(absTo, 0, moved);
                    updateQueueUI();

                    if (state.blend.isHost) {
                        // host applies change and broadcasts authoritative queue
                        broadcastToAll({ type: 'queue-reorder', queue: state.blend.queue });
                    } else {
                        // non-host: request host to apply reorder by track id and relative target
                        sendToHost({ type: 'queue-reorder-request', id: track.id, to: to });
                    }
                });

                // wire up remove button
                const removeBtn = item.querySelector('.remove-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        const relIndex = parseInt(item.dataset.index, 10);
                        const absIndex = relIndex + state.currentIndex + 1;
                        if (isNaN(absIndex)) return;
                        // If host, apply removal and broadcast; else request host to remove
                        if (state.blend.isHost) {
                            if (absIndex >= 0 && absIndex < state.blend.queue.length) {
                                state.blend.queue.splice(absIndex, 1);
                                state.playlist = state.blend.queue;
                                updateQueueUI();
                                broadcastToAll({ type: 'queue-remove', index: absIndex });
                            }
                        } else {
                            sendToHost({ type: 'queue-remove-request', index: absIndex, id: removeBtn.dataset.id });
                        }
                    });
                }
            });
        }

        window.addToBlendQueue = function (index) {
            if (!state.blend.active) return;

            const track = state.allTracks[index];
            console.log('Adding to queue:', track.name);

            state.blend.queue.push(track);
            state.playlist = state.blend.queue;
            updateQueueUI();

            const message = { type: 'queue-add', track };
            broadcastToAll(message);

            // Only host triggers auto-play
            if (state.blend.isHost && state.blend.queue.length === 1 && !state.currentTrack) {
                setTimeout(() => {
                    playTrack(0);
                }, 300);
            }
        };

        let blendSearchTimeout;
        el.blendSearchInput.addEventListener('input', (e) => {
            clearTimeout(blendSearchTimeout);
            const query = e.target.value.trim();
            if (query) {
                blendSearchTimeout = setTimeout(async () => {
                    try {
                        const saavnApi = API_SOURCES[0];
                        const tracks = await saavnApi.search(query);

                        el.blendSearchResults.innerHTML = tracks.slice(0, 5).map((t, i) => `
                            <div class="track-card" style="cursor: pointer;" onclick="addToBlendFromSearch(${i}, '${query}')">
                                <img class="track-cover" src="${t.cover}">
                                <div class="track-details">
                                    <div class="track-title">${t.name}</div>
                                    <div class="track-subtitle">${t.artists}</div>
                                </div>
                            </div>
                        `).join('');

                        window.blendSearchCache = tracks;
                    } catch (e) {
                        console.error('Search error:', e);
                    }
                }, 500);
            } else {
                el.blendSearchResults.innerHTML = '';
            }
        });

        window.addToBlendFromSearch = function (index, query) {
            const track = window.blendSearchCache[index];
            if (track) {
                state.blend.queue.push(track);
                state.playlist = state.blend.queue;
                updateQueueUI();

                broadcastToAll({ type: 'queue-add', track });

                el.blendSearchInput.value = '';
                el.blendSearchResults.innerHTML = '';

                // Only host triggers auto-play
                if (state.blend.isHost && state.blend.queue.length === 1 && !state.currentTrack) {
                    setTimeout(() => playTrack(0), 300);
                }
            }
        };

        el.blendAvatar.addEventListener('click', () => {
            el.blendAvatarInput.click();
        });

        el.blendAvatarInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    el.blendAvatar.innerHTML = `<img src="${event.target.result}" alt="Avatar">`;
                    state.blend.avatar = event.target.result;

                    // Broadcast avatar change
                    if (state.blend.active) {
                        broadcastToAll({
                            type: 'blend-metadata-update',
                            avatar: state.blend.avatar
                        });
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        el.editBlendNameBtn.addEventListener('click', () => {
            const newName = prompt('Enter blend name:', state.blend.name);
            if (newName && newName.trim()) {
                state.blend.name = newName.trim();
                el.blendNameDisplay.textContent = state.blend.name;

                // Broadcast name change
                if (state.blend.active) {
                    broadcastToAll({
                        type: 'blend-metadata-update',
                        name: state.blend.name
                    });
                }
            }
        });

        el.shareBlendBtn.addEventListener('click', () => {
            const shareUrl = `${window.location.origin}${window.location.pathname}?blend=${state.blend.id}`;
            navigator.clipboard.writeText(shareUrl);

            const originalHTML = el.shareBlendBtn.innerHTML;
            el.shareBlendBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
            setTimeout(() => {
                el.shareBlendBtn.innerHTML = originalHTML;
            }, 2000);
        });

        el.createBlendBtn.addEventListener('click', createBlendSession);

        el.joinBlendBtn.addEventListener('click', () => {
            el.joinBlendModal.classList.add('active');
        });

        el.leaveBlendBtn.addEventListener('click', leaveBlendSession);

        el.confirmJoinBlendBtn.addEventListener('click', () => {
            let input = el.joinBlendInput.value.trim();
            if (input.includes('?blend=')) {
                input = input.split('?blend=')[1].split('&')[0];
            }
            if (input) {
                el.joinBlendModal.classList.remove('active');
                joinBlendSession(input);
            }
        });

        el.cancelJoinBlendBtn.addEventListener('click', () => {
            el.joinBlendModal.classList.remove('active');
        });

        checkBlendUrl();
    </script>
</body>

</html>